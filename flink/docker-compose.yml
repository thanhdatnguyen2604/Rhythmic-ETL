version: '3.7'

networks:
  flink-network:
    driver: bridge

services:
  jobmanager:
    image: flink:1.17.0
    hostname: jobmanager
    container_name: jobmanager
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        jobmanager.memory.process.size: 1024m
        parallelism.default: 1
        state.backend: filesystem
        state.checkpoints.dir: file:///opt/flink/checkpoints
        execution.checkpointing.interval: 60000
        execution.checkpointing.mode: EXACTLY_ONCE
        execution.checkpointing.timeout: 30000
        restart-strategy: fixed-delay
        restart-strategy.fixed-delay.attempts: 3
        restart-strategy.fixed-delay.delay: 10000
    volumes:
      - ./checkpoints:/opt/flink/checkpoints
      - ./jobs:/opt/flink/jobs
      - ./config:/opt/flink/config
      - ./secrets:/opt/flink/secrets
    networks:
      - flink-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/overview"]
      interval: 10s
      timeout: 5s
      retries: 3

  taskmanager:
    image: flink:1.17.0
    hostname: taskmanager
    container_name: taskmanager
    depends_on:
      - jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.memory.process.size: 1536m
        taskmanager.memory.managed.size: 512m
        taskmanager.numberOfTaskSlots: 2
        parallelism.default: 1
        state.backend: filesystem
        state.checkpoints.dir: file:///opt/flink/checkpoints
    volumes:
      - ./checkpoints:/opt/flink/checkpoints
      - ./jobs:/opt/flink/jobs
      - ./config:/opt/flink/config
      - ./secrets:/opt/flink/secrets
    networks:
      - flink-network
    restart: unless-stopped

  jobs-builder:
    build:
      context: .
      dockerfile: Dockerfile.jobs
    container_name: jobs-builder
    depends_on:
      - jobmanager
      - taskmanager
    volumes:
      - ./jobs:/opt/flink/jobs
      - ./config:/opt/flink/config
      - ./secrets:/opt/flink/secrets
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/opt/flink/secrets/cred.json
      - KAFKA_BROKER=kafka-vm:9092
      - GCS_BUCKET=rhythmic-bucket
      - CHECKPOINT_DIR=file:///opt/flink/checkpoints
      - CHECKPOINT_INTERVAL=60000
      - PARALLELISM=1
    networks:
      - flink-network

networks:
  flink-network:
    driver: bridge 